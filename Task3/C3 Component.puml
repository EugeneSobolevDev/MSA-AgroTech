@startuml C3_Вариант1
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

System_Boundary(система, "Платформа мониторинга скота (MVP)") {

    Container_Boundary(агент_фермы, "Агент фермы (Edge)") {

        Container_Boundary(ml_сервер, "Сервер видеоаналитики") {
            Component(видео_клиент, "Видео клиент", "RTMP", "Прием видеопотоков с камер, предпроцессинг для ML")
            Component(ml_модель, "ML Модель", "Предоставляется подрядчиком", "Обработка фото и видео")
            Component(детектор_событий, "Детектор событий", "Java", "Обнаружение ЧП: драки, задавливания")
            Component(трекер_животных, "Трекер животных", "Java", "Подсчет животных")
            Component(сервис_камер, "Сервис камер", "Java", "Управление состояниями камер")
        }

        Container_Boundary(локальная_бд, "БД Фермы") {
            ComponentDb(таблица_событий, "Таблица событий", "SQL", "Хранение обнаруженных событий")
            ComponentDb(таблица_метрик, "Таблица метрик", "SQL", "Телеметрия с датчиков")
            ComponentDb(таблица_животных, "Таблица животных", "SQL", "Информация о животных")
            ComponentDb(таблица_правил_уведомлений, "Таблица правил оповещений", "SQL", "Информация о настройке оповещений")
        }

        Container_Boundary(iot_шлюз, "IoT шлюз") {
            Component(mqtt_брокер, "MQTT брокер", "Mosquitto", "Локальный брокер сообщений")
            Component(сервис_кормушек, "Сервис кормушек", "Java", "Управление умными кормушками")
            Component(сервис_датчиков, "Сервис датчиков", "Java", "Сбор данных с датчиков")
            Component(менеджер_устройств, "Менеджер устройств", "Java", "Реестр и состояние оборудования")
        }

        Container_Boundary(локальный_веб, "Локальный веб-портал") {
            Component(фронтенд, "Фронтенд приложение", "React", "Пользовательский интерфейс")
            Component(api_gateway, "API Gateway", "Java", "Обработка HTTP/WebSocket запросов")
        }

        Container_Boundary(сервис_оповещений, "Сервис оповещений") {
            Component(отправитель_уведомлений, "Отправитель уведомлений", "Java", "Отправка SMS, email, push, согласно правилам")
            Component(очередь_оповещений, "Очередь оповещений", "Kafka", "Буферизация сообщений")
        }

        Component(синхронизатор, "Сервис синхронизации", "Java", "Отправка данных в центр, retry-логика")
    }
}

Rel(видео_клиент, ml_модель, "Передает кадры", "Shared memory")
Rel(ml_модель, детектор_событий, "Результаты распознавания", "Protobuf")
Rel(ml_модель, трекер_животных, "Результаты распознавания", "Protobuf")
Rel(сервис_датчиков, таблица_метрик, "Сохраняет телеметрию", "JDBC")
Rel(таблица_метрик, ml_модель, "RFID-метки для точного подсчета животных", "JDBC")
Rel(трекер_животных, таблица_животных, "JDBC")
Rel(mqtt_брокер, сервис_кормушек, "Команды управления", "MQTT")
Rel(детектор_событий, таблица_событий, "Сохраняет события", "JDBC")
Rel(детектор_событий, очередь_оповещений, "Создаёт оповещения", "Kafka")
Rel(таблица_событий, синхронизатор, "Данные для отправки", "JDBC")
Rel(синхронизатор, приемник_данных, "Отправка данных", "HTTPS")
Rel(таблица_правил_уведомлений, отправитель_уведомлений, "Считывает правила уведомлений")
Rel(api_gateway, таблица_правил_уведомлений, "Создает/редактирует правила уведомлений")

Rel(синхронизатор, приемник_данных, "Периодическая синхронизация", "HTTPS")
Rel(фронтенд, api_gateway, "API запросы", "HTTPS")
Rel(таблица_событий, api_gateway, "Чтение данных", "JDBC")
Rel(очередь_оповещений, отправитель_уведомлений, "Kafka")

Rel(датчики, mqtt_брокер, "Отправка данных", "MQTT")
Rel(mqtt_брокер, сервис_датчиков, "Распределение сообщений", "MQTT")
Rel(сервис_кормушек, кормушки, "Управляющие команды", "MQTT")
Rel(камеры, видео_клиент, "Видеопотоки", "TCP/UDP")

Rel(оператор_фермы, фронтенд, "Локальный мониторинг", "HTTP/WebSocket")
Rel(директор, центральный_фронтенд, "Управление через портал", "HTTPS")
Rel(отправитель_уведомлений, оператор_фермы, "Экстренные оповещения", "Push/SMS/Email")

@enduml