### <a name="_b7urdng99y53"></a>**ADR 001: Платформа для мониторинга скота** 
### <a name="_hjk0fkfyohdk"></a>**Автор: Соболев Е.В.**
### <a name="_uanumrh8zrui"></a>**Дата: 30.11.2025**
### <a name="_3bfxc9a45514"></a>**Функциональные требования**
### Контекст
Компания «АгроТех Х» нуждается в MVP системы мониторинга свиноводческих ферм, которая должна работать в условиях нестабильной связи, 
обеспечивать автономность ферм и аналитику в реальном времени. 
Существующие рыночные решения не подходят из-за законодательных ограничений и высокой стоимости.
IT-ландшафт компании включает разнородные системы (ERP, BI, IoT-платформу), с которыми необходимо интегрироваться. 
На фермах присутствуют проблемы с WiFi-покрытием, требуется обработка видео с камер в ночное время и трекинг похожих друг на друга животных,
известна проблема, что нейронные сети путают тень животного с самим животным — для MVP не критично.
Готовую нейросетевую модель предоставят партнёры.

| **№** |  **Действующие лица или системы**   |                     **Use Case**                      |                                                                                                                                                                                                                                         **Описание**                                                                                                                                                                                                                                         |
|:-----:|:-----------------------------------:|:-----------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|   1   | Оператор фермы, Система мониторинга | Получение экстренного оповещения о нештатной ситуации |   1. Система: Автоматически обнаруживает драку, задавливание поросят или другое ЧП через видеоаналитику<br>2. Система: Формирует оповещение с типом события и локацией<br>3. Оператор: Получает звуковое и визуальное уведомление на локальном устройстве в течение 5 секунд<br>4. Оператор: Подтверждает оповещение и направляется к месту события<br>5. Оператор: Фиксирует в системе принятые меры и результат<br>6. Система: Отмечает инцидент как обработанный и сохраняет в историю    |   
|   2   | Оператор фермы, Система мониторинга |           Управление кормушками и поилками	           |       1. Пользователь: Открывает интерфейс управления кормушками в веб-портале или мобильном приложении<br>2. Система: Отображает текущий статус всех кормушек (заполненность, режим работы)<br>3. Пользователь: Выбирает конкретную кормушку и устанавливает параметры кормления<br>4. Система: Отправляет команду на оборудование и подтверждает выполнение<br>5. Пользователь: Видит изменение статуса кормушки в реальном времени<br>6. Система: Логирует все операции управления        | 
|   3   |        Аналитик, BI система         |        Работа с BI-системой для анализа данных        | 1. Аналитик: Запускает BI-систему и подключается к источнику данных<br>2. Система: Предоставляет доступ к агрегированным данным и историческим метрикам<br>3. Аналитик: Строит пользовательские отчеты и дашборды для анализа эффективности<br>4. Аналитик: Проводит сравнительный анализ показателей разных ферм и периодов<br>5. Система: Выполняет сложные аналитические запросы и предоставляет визуализации<br>6. Аналитик: Формулирует выводы и рекомендации для оптимизации процессов |   
|   4   |   Директор хозяйства, Web-портал    |       Просмотр сводной аналитики по всем фермам       |    1. Директор: Заходит в веб-портал<br>2. Система: Отображает сводный дашборд с KPI всех ферм<br>3. Директор: Анализирует ключевые показатели эффективности (количество, состояние животных, расход кормов, продуктивность)<br>4. Директор: Детализирует данные до уровня отдельных ферм и временных периодов<br>5. Система: Предоставляет инструменты для сравнительного анализа и выявления тенденций<br>6. Директор: Формирует стратегические решения на основе полученной аналитики     |   
|   5   |   Директор хозяйства, Web-портал    |      Управление доступом и ролями пользователей       |                               1. Директор: Открывает раздел управления пользователями в веб-портале<br>2. Система: Отображает список всех пользователей и их ролей<br>3. Директор: Назначает права доступа для новых сотрудников<br>4. Директор: Корректирует роли существующих пользователей при изменении обязанностей<br>5. Система: Применяет изменения и уведомляет пользователей<br>6. Директор: Мониторит активность пользователей через систему аудита                               |   

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Опишите здесь нефункциональные требования и архитектурно значимые требования.

| **№** | **Требование**                                                                                                      |
|:-----:|:--------------------------------------------------------------------------------------------------------------------|
|   1   | Отказоустойчивость 99.95%                                                                                           |
|   2   | Система должны быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего |
|   3   | Оповещение о нештатной ситуации в течение 5 секунд                                                                  |
|   4   | Реакция системы видеоаналитики в реальном времени (миллисекунды)                                                    |
|   5   | Отказоустойчивость 99.95%                                                                                           |

### <a name="_qmphm5d6rvi3"></a>**Решение**
### Вариант 1. Автономные агенты (Edge-система)
@startuml C1_Вариант1
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

Person(директор, "Директор хозяйства", "Управление через веб-портал")
Person(аналитик, "Аналитик", "Работа с BI-системой")
Person(оператор, "Оператор мониторинга", "Контроль состояния животных, запасов корма")

System(агент_фермы, "Агент фермы (Edge)", "Обработка телеметрии, буферизация, экстренные уведомления, ML-сервер для обработки видео и рекомендаций")
System(центральный_сервер, "Центральный сервер", "Агрегация данных с ферм, долгосрочная аналитика, отчетность, глубокая видеоаналитика")
System_Ext(erp_system, "ERP система (1С:Агро)", "Финансы, склад, кадры")
System_Ext(bi_system, "BI система", "Отчеты и визуализация")

Rel(агент_фермы, центральный_сервер, "Передача данных\n(задержка до 10 минут)")
Rel(директор, центральный_сервер, "Использует")
Rel(центральный_сервер, bi_system, "Передает данные")
Rel(центральный_сервер, erp_system, "Передает данные")
Rel(erp_system, центральный_сервер, "Передает обработанные данные")
Rel(аналитик, bi_system, "Анализирует")
Rel_R(оператор, агент_фермы, "Получает экстренные уведомления, отчитывается об исправлении ситуации")
@enduml

### Вариант 2. Централизованная аналитика с легкими агентами
@startuml C1_Вариант2
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

Person(директор, "Директор хозяйства", "Управление через веб-портал")
Person(аналитик, "Аналитик", "Работа с BI-системой")
Person(оператор, "Оператор мониторинга", "Контроль состояния животных, запасов корма")

System(агент_сбора, "Агент сбора данных", "Сбор телеметрии, буферизация, базовые триггеры, передача видео")
System(центральный_сервер, "Центральный сервер", "Глубокая видеоаналитика, ML-обработка, управление, отчетность")
System_Ext(erp_system, "ERP система (1С:Агро)", "Финансы, склад, кадры")
System_Ext(bi_system, "BI система", "Отчеты и визуализация")

Rel(агент_сбора, центральный_сервер, "Передача видео и телеметрии\n(задержка до 10 минут)")
Rel(центральный_сервер, агент_сбора, "Команды управления, экстренные оповещения")
Rel(директор, центральный_сервер, "Использует")
Rel(аналитик, bi_system, "Анализирует")
Rel_R(оператор, агент_сбора, "получает оповещения от центра")
Rel(центральный_сервер, bi_system, "Передает данные")
Rel(центральный_сервер, erp_system, "Передает данные")
Rel(erp_system, центральный_сервер, "Передает обработанные данные")
@enduml

|           **Критерий**           | **Вариант 1**        | **Вариант 2**                           |
|:--------------------------------:|:---------------------|:----------------------------------------|
| Функциональность агента на ферме | Полная ML-аналитика  | Только сбор данных + базовые триггеры   |
|              Трафик              | Мета-данные, события | Видеопотоки, сырые данные               |
|       Требования к агенту        | Мощные GPU/CPU       | Минимальные (буферизация)               |
|         Скорость реакции         | <5 сек (локально)    | Зависит от связи с центром              |
|       Работа без интернета       | Полная автономность  | Только сбор данных + базовые оповещения |
|            Стоимость             | Высокая              | Средняя                                 |

### Вариант 1: "Автономные агенты (Edge-система)" - вся аналитика и обработка видео-потоков происходит на ферме, центр получает готовые метрики.
### Вариант 2: "Централизованная аналитика с легкими агентами" - агенты только собирают данные, вся аналитика в центре.

Оба строго соответствуют архитектуре "центральный сервер — агенты" с задержкой синхронизации до 10 минут, но по-разному распределяют вычислительную нагрузку, предполагают различные финансовые затраты.

### При разработке вариантов архитектуры были учтены указанные выше нефункциональные, а также следующие функциональные требования:
### Функциональные требования к системе
Система должна:
- фиксировать признаки беспокойного поведения или драк среди животных и оповещать оператора;
- фиксировать признаки задавливания поросят;
- управлять кормушками и поилками разных производителей;
- оценивать состояние животных по внешнему виду и поведению: болезнь, гибель, беспокойство и так далее;
- следить за состоянием систем фильтрации воды;
- пересчитывать поголовье;
- следить за запасами еды и прогнозировать расход;
- делать пересчёт животных;
- поддерживать необходимое количество видеокамер для аналитики в реальном времени от разных производителей;
- быть построена по принципу «центральный сервер — агенты» на конкретных фермах без ограничения количества таких агентов (в синхронизации между агентами и центральным сервером допускается задержка до 10 минут без учёта проблем со связью);
- предоставлять базовые метрики для передачи в другие системы;
- поддерживать возможность добавления собственных метрик;
- работать даже в случае отсутствия интернета и при необходимости отправлять уведомления дежурному сотруднику на местах мониторинга, а после восстановления связи синхронизироваться с центральной системой;
- иметь разделение ролей и поддерживать современные способы аутентификации и авторизации;
- иметь API для создания мобильного приложения или веб-приложения.

### Основной выбор
Вариант 1. "Автономные агенты (Edge-система)"
Данная архитектура обеспечивает баланс между надежностью, производительностью и стоимостью, 
полностью соответствуя заявленным функциональным и нефункциональным требованиям.

Соответствие требованиям:
- Работа без интернета - полная автономность агентов
- Оповещение за 5 сек - локальная обработка на агенте
- Задержка синхронизации до 10 мин - периодический обмен данными

### Распределение функциональности между агентом и центром
На агенте: 
- Критически важные функции реального времени
- Видеоаналитика и ML-обработка
- Локальные оповещения оператору
- Управление оборудованием
- Буферизация данных

В центре: 
- Аналитика и управление
- Долгосрочная аналитика и отчетность
- Хранение исторических данных
- Управление конфигурацией агентов

### Ограничения и риски
- Проблемы с WiFi: Автономность агентов решает проблему
- Качество видеоаналитики: Постепенное улучшение ML-моделей
- Интеграция с существующими системами: API-шлюз для совместимости
- Разделение ответственности между агентами и центром для масштабируемости
- Стандартные протоколы для упрощения интеграции и поддержки

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Вариант 2: "Централизованная аналитика с легкими агентами"
Данная архитектура ориентирована на быстрое достижение бизнес-результатов с минимальными инвестициями, 
с осознанным принятием ограничений по автономности работы.
Основные отличия от Варианта 1:
- Фокус на экономической эффективности, а не максимальной автономности
- Централизация интеллекта для упрощения поддержки и развития
- Принятие компромиссов по скорости реакции в обмен на снижение стоимости
- Поэтапное развитие - возможность миграции к Варианту 1 в будущем

Обоснование: Снижение стоимости и сложности edge-оборудования

### Распределение функциональности
На агенте: Минимально необходимые функции
- Сбор и буферизация сырых данных
- Базовые триггеры по простым правилам (движение, звук, пустая кормушка)
- Передача данных в центр при наличии связи
- Получение и исполнение команд из центра

В центре: Вся интеллектуальная обработка
- Глубокая ML-аналитика видео
- Сложная бизнес-логика
- Агрегация данных со всех ферм

### Ограничения и риски
- Проблемы со связью: Расширенная буферизация и оффлайн-режим
- Нагрузка на сеть: Адаптивное качество видео и компрессия


**Недостатки, ограничения, риски**
Высокая стоимость - агенты с GPU дороже легких решений, длительная окупаемость
Долгое внедрение - сложное развертывание на каждой ферме
Риск потери части данных при происшествиях (пожар, затопления)