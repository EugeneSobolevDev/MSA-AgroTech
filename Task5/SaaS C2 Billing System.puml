@startuml SaaS_C2_Billing_System
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(клиент, "Клиент", "Управляет подпиской")
Person(бухгалтер, "Бухгалтер", "Финансовый учет")
Person(продажи, "Бизнес(продажи)", "Работает со счетами клиентов")

System_Boundary(система, "SaaS Платформа мониторинга скота") {

    Container_Boundary(агент_фермы, "Агент фермы") {
        Container(ml_сервер, "ML сервер", "ML модели", "Обработка видеопотоков")
        ContainerDb(локальная_бд, "Локальная БД", "PostgreSQL", "Кэш данных фермы")
    }

    Container_Boundary(центральный_сервер, "Центральный сервер") {
        Container(api_шлюз, "API Gateway", "Java", "Точка входа")
        ContainerDb(центральная_бд, "Центральная БД", "PostgreSQL", "Данные клиента")

        Container(сервис_аналитики, "Сервис аналитики", "Java", "Расчет метрик использования")
        Container(сервис_уведомлений, "Сервис уведомлений", "Java", "Отправка email/SMS")

        Container(веб_портал, "Веб-портал", "React", "Личный кабинет клиента")
    }

    Container_Boundary(биллинг_система, "Система биллинга") {
        Container(тарификатор, "Сервис тарификации", "Java", "Расчет стоимости")
        Container(платежный_шлюз, "Платежный шлюз", "Java", "Интеграция с эквайрингом")
        Container(менеджер_подписок, "Менеджер подписок", "Java", "Управление подписками")

        ContainerDb(бд_биллинга, "БД биллинга", "PostgreSQL", "Счета, платежи, подписки")
        Container(сервис_отчетов, "Сервис отчетов", "Java", "Финансовая отчетность")
    }
}

System_Ext(юkassa, "ЮKassa", "Платежная система")
System_Ext(robokassa, "RoboKassa", "Платежная система")
System_Ext(сбп, "СБП", "Система быстрых платежей")
System_Ext(бухгалтерия, "1С:Бухгалтерия", "Корпоративная бухгалтерия")

Rel(агент_фермы, сервис_аналитики, "Метрики использования", "HTTPS")
Rel(сервис_аналитики, тарификатор, "Метрики использования", "Kafka")
Rel(тарификатор, бд_биллинга, "Начисления")

Rel(клиент, веб_портал, "Управление подпиской", "HTTPS")
Rel(веб_портал, менеджер_подписок, "Изменения подписки", "REST API")
Rel(менеджер_подписок, платежный_шлюз, "Запрос на оплату", "REST API")

Rel(платежный_шлюз, юkassa, "Создание платежа", "REST API")
Rel(платежный_шлюз, robokassa, "Создание платежа", "REST API")
Rel(платежный_шлюз, сбп, "Инициирование перевода", "REST API")

Rel(юkassa, платежный_шлюз, "Вебхук об оплате", "HTTPS + signature")
Rel(robokassa, платежный_шлюз, "Вебхук об оплате", "HTTPS + signature")

Rel(платежный_шлюз, бд_биллинга, "Регистрация платежа", "SQL")
Rel(бд_биллинга, менеджер_подписок, "Обновление статуса подписки")

Rel(менеджер_подписок, сервис_уведомлений, "Уведомление клиенту", "Kafka")
Rel(сервис_уведомлений, клиент, "Email/SMS о платеже", "SMTP/Twilio")

Rel(сервис_отчетов, бухгалтерия, "Выгрузка проводок")
Rel(бухгалтер, сервис_отчетов, "Формирование отчетов", "Web UI")

Rel(продажи, менеджер_подписок, "Корректировки подписок", "Admin API")
Rel(продажи, тарификатор, "Настройка тарифов", "Admin API")

@enduml