@startuml SaaS_C2_Вариант_2
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(клиент1, "Ферма А", "Работает с сервисом")
Person(клиент2, "Ферма Б", "Работает с сервисом")
Person(админ, "Администратор", "Управляет платформой")

System_Boundary(система, "SaaS Платформа мониторинга скота") {

    Container_Boundary(агент_фермы_клиент1, "Агент фермы - Клиент А") {
        Container(ml_клиент1, "ML сервер", "ML модели", "Обработка видеопотоков")
        ContainerDb(бд_клиент1, "Локальная БД", "PostgreSQL", "Кэш данных фермы")
    }

    Container_Boundary(агент_фермы_клиент2, "Агент фермы - Клиент Б") {
        Container(ml_клиент2, "ML сервер", "ML модели", "Обработка видеопотоков")
        ContainerDb(бд_клиент2, "Локальная БД", "PostgreSQL", "Кэш данных фермы")
    }

    Container_Boundary(центральный_сервер, "Центральный сервер SaaS") {
        Container(api_шлюз, "API Gateway", "Java + DB Routing", "Динамическая маршрутизация к БД")
        Container(сервис_агрегации, "Сервис агрегации", "Java", "Агрегирует данные из локальных БД ферм")

        ContainerDb(бд_общая, "Общая БД", "PostgreSQL", "Метаданные, пользователи, биллинг")

        Container_Boundary(tenant_databases, "Отдельные БД клиентов") {
            ContainerDb(бд_клиент1_ц, "БД: db_tenant_a", "PostgreSQL", "Изолированные данные клиента А")
            ContainerDb(бд_клиент2_ц, "БД: db_tenant_b", "PostgreSQL", "Изолированные данные клиента Б")
        }

        Container(менеджер_подключений, "Менеджер подключений", "Java + HikariCP", "Пул соединений к разным БД")
        Container(веб_портал, "Веб-портал", "React", "Мультитенантный UI с выбором БД")
    }
}

Rel(клиент1, веб_портал, "Работает через портал", "HTTPS → перенаправление к своей БД")
Rel(клиент2, веб_портал, "Работает через портал", "HTTPS → перенаправление к своей БД")
Rel(админ, веб_портал, "Управляет клиентами", "HTTPS → доступ ко всем БД")

Rel(бд_клиент1, сервис_агрегации, "Синхронизация", "HTTPS + tenant")
Rel(бд_клиент2, сервис_агрегации, "Синхронизация", "HTTPS + tenant")

Rel(веб_портал, api_шлюз, "API запросы", "HTTPS с tenant")
Rel(api_шлюз, менеджер_подключений, "Определение БД клиента", "согласно tenant")
Rel(менеджер_подключений, бд_клиент1, "Подключение к БД клиента А", "JDBC:tenant_a")
Rel(менеджер_подключений, бд_клиент2, "Подключение к БД клиента Б", "JDBC:tenant_b")

Rel(сервис_агрегации, менеджер_подключений, "Запрос подключения", "tenant")
Rel(менеджер_подключений, сервис_агрегации, "Возврат DataSource", "Hikari DataSource")

Rel(api_шлюз, бд_общая, "Проверка клиента, аутентификация", "SQL")
Rel(менеджер_подключений, бд_общая, "Получение конфигураций БД", "SQL: конфиг нода")

@enduml