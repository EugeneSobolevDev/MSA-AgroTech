@startuml SaaS_C2_Вариант_1
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(клиент1, "Ферма А", "Работает с сервисом")
Person(клиент2, "Ферма Б", "Работает с сервисом")
Person(админ, "Администратор", "Управляет платформой")

System_Boundary(система, "SaaS Платформа мониторинга скота") {

    Container_Boundary(агент_фермы_клиент1, "Агент фермы - Клиент А") {
        Container(ml_клиент1, "ML сервер", "ML модели", "Обработка видеопотоков")
        ContainerDb(бд_клиент1, "Локальная БД", "PostgreSQL", "Кэш данных фермы")
    }

    Container_Boundary(агент_фермы_клиент2, "Агент фермы - Клиент Б") {
        Container(ml_клиент2, "ML сервер", "ML модели", "Обработка видеопотоков")
        ContainerDb(бд_клиент2, "Локальная БД", "PostgreSQL", "Кэш данных фермы")
    }

    Container_Boundary(центральный_сервер, "Центральный сервер SaaS") {
        Container(api_шлюз, "API Gateway", "Java + Tenant ID", "Маршрутизация по tenant_id")
        Container(сервис_агрегации, "Сервис агрегации", "Java", "Обработка данных всех клиентов")
        ContainerDb(центральная_бд, "Центральная БД", "PostgreSQL", "Все схемы клиентов в одном инстансе")

        Container_Boundary(tenant_schemas, "Схемы БД по клиентам") {
            ContainerDb(схема_клиент1, "Схема: tenant_a", "PostgreSQL", "Данные клиента А")
            ContainerDb(схема_клиент2, "Схема: tenant_b", "PostgreSQL", "Данные клиента Б")
            ContainerDb(схема_общая, "Схема: shared", "PostgreSQL", "Общие справочники, пользователи")
        }

        Container(веб_портал, "Веб-портал", "React + Tenant", "Мультитенантный UI")
    }
}

Rel(клиент1, веб_портал, "Работает через портал", "HTTPS + tenant_id")
Rel(клиент2, веб_портал, "Работает через портал", "HTTPS + tenant_id")
Rel(админ, веб_портал, "Управляет всеми клиентами", "HTTPS + admin")

Rel(бд_клиент1, сервис_агрегации, "Синхронизация", "HTTPS + tenant_id")
Rel(бд_клиент2, сервис_агрегации, "Синхронизация", "HTTPS + tenant_id")
Rel(сервис_агрегации, схема_клиент1, "Запись данных", "SQL (схема tenant_заря)")
Rel(сервис_агрегации, схема_клиент2, "Запись данных", "SQL (схема tenant_рассвет)")

Rel(веб_портал, api_шлюз, "API запросы", "HTTPS + JWT с tenant_id")
Rel(api_шлюз, сервис_агрегации, "Маршрутизация по tenant", "gRPC + tenant контекст")

Rel(схема_клиент1, схема_общая, "Ссылки на общие данные", "SQL")
Rel(схема_клиент2, схема_общая, "Ссылки на общие данные", "SQL")

@enduml